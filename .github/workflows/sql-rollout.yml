name: "Rollout Bytebase generated plan"

on:
  workflow_call:
    inputs:
      bytebase-url:
        description: "Bytebase instance URL"
        required: true
        type: string
      bytebase-service-account:
        description: "Bytebase service account email"
        default: "bytebase@service.bytebase.com"
        required: true
        type: string
      plan-type:
        description: "Plan type identifier (e.g., nonprod, prod)"
        default: "nonprod"
        required: true
        type: string
    secrets:
      bytebase-service-account-secret:
        description: "Bytebase service account secret"
        required: true
      access-token:
        description: "Personal Access Token with repo and workflow scopes"
        required: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.extract-info.outputs.env }}
      dir: ${{ steps.extract-info.outputs.dir }}
      service: ${{ steps.extract-info.outputs.service }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          dir_names: "false"
          files_yaml: |
            sql:
              - "*.up.sql"

      - name: Extract service and environment info
        id: extract-info
        run: |
          SQL_FILES="${{ steps.changed-files.outputs.sql_all_changed_files }}"
          if [ -z "$SQL_FILES" ]; then
            SQL_FILES="${{ steps.changed-files.outputs.sql_other_changed_files }}"
          fi
          if [ -z "$SQL_FILES" ]; then
            SQL_FILES="${{ steps.changed-files.outputs.sql_other_modified_files }}"
          fi

          if [ -n "$SQL_FILES" ]; then
            DIR=$(echo "$SQL_FILES" | tr ' ' '\n' | grep '\.sql$' | xargs -n1 dirname | head -n1)
            SERVICE=$(cut -d'/' -f1 <<<"$DIR")
            ENV=$(cut -d'/' -f3 <<<"$DIR")
            echo "env=$ENV" >> $GITHUB_OUTPUT
            echo "dir=$DIR" >> $GITHUB_OUTPUT
            echo "service=$SERVICE" >> $GITHUB_OUTPUT
            echo "Detected service: $SERVICE, env: $ENV from dir: $DIR"
          else
            echo "No SQL files changed"
            echo -e "service=\nenv=" >> $GITHUB_OUTPUT
          fi

      - name: Get run ID of latest successful run
        id: get-run
        run: |
          RUN_ID=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.access-token }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/naing2htun/${{ steps.extract-info.outputs.service }}/actions/workflows/sql-plan.yml/runs?status=success&branch=main" \
            | jq -r '.workflow_runs[0].id')

          echo "run-id=$RUN_ID" >> $GITHUB_OUTPUT

      # download plan artifact from service repo
      - name: Download rollout plan artifact
        id: download-artifact
        uses: actions/download-artifact@v5
        with:
          name: bytebase-plan-${{ inputs.plan-type }}
          github-token: ${{ secrets.access-token }}
          repository: naing2htun/${{ steps.extract-info.outputs.service }}
          run-id: ${{ steps.get-run.outputs.run-id }}

      # upload downloaded plan as artifact for rollout job
      - name: Upload plan for rollout job
        uses: actions/upload-artifact@v4
        with:
          name: rollout-plan-${{ github.run_id }}
          path: ${{ steps.download-artifact.outputs.download-path }}/plan.txt
          retention-days: 1

  rollout:
    needs: prepare
    runs-on: ubuntu-latest
    container:
      image: bytebase/bytebase-action:${{ vars.BYTEBASE_ACTION_VERSION }}
    steps:
      - name: Download plan
        uses: actions/download-artifact@v5
        with:
          name: rollout-plan-${{ github.run_id }}
          path: /tmp

      - name: Rollout to ${{ needs.prepare.outputs.env }}
        run: |
          bytebase-action rollout \
            --url=${{ inputs.bytebase-url }} \
            --service-account=${{ inputs.bytebase-service-account }} \
            --service-account-secret='${{ secrets.bytebase-service-account-secret }}' \
            --project=projects/${{ needs.prepare.outputs.service }} \
            --target-stage=environments/${{ needs.prepare.outputs.env }} \
            --plan=$(cat /tmp/plan.txt)